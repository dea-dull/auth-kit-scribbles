list  of resources for the drives section 

Functions:
  - getPresignedUrl function: this generates a presigned url for uploads - posting(only allowed to the drive-unscanned bucket ),
  downloads - getting files from the (drive) bucket only

  - PresignedUrlShare function: this would be the function that generates the presigned url for users to share files,
  the user will have the option to pick between minutes, hours or at most 7 days before the url for sharing expires


3 S3 buckets 
    - drive-unscanned
        -  S3 bucket (not necassarily public but the default bucket where all files land)
            users can only perform post methods to input their files (users are grouped into folders(with their userID), 
            this shouldn't mean knowing a userID means being able to access their folder tho)
            (in their their frontend specific paths of course ), 
            Lambda function starts the scnning process of files (25 in a queue maybe) with clamAV ( an aws marketplace
            software) or smth related        
    - drive 
        - actual drive where the files that have passed the check for viruses are stored, ofc stored in their own 
        folders according to the user_id
    - drive quanrantined
        - where the files that haven't passed the virus check are sent to, for logging the user (finding out if it 
        was a malicious attempt ), more scanning if there needs to be and deletion 
  


Dynamo DB tables
    - scan-table
        stores the meta-data  used to track the progress of files uploaded before virus scanning, during scanning and after
        scanning (only if quarantined). must have a primary key (partition key (user_id) and sort key (file_id)), 
        also have attributes like uploaded at, MIMEType, path on the frontend, S3 key, file size,
        status ("pending", "in_progress", "clean", "infected", "error") , errorMessage if the scan failed (timeout, corrupted file, etc.).
        Checksum / Hash, Quarantined 	Boolean	Whether the file has been quarantined or isolated.
        QuarantineLocation S3 path where infected files are moved (if applicable).
         (the quarantined and quarantine location attribute should only be for files with the status infected)
    
    - drive-table
         this stores all the meta data for the actual drive bucket with the primary key being the same and 
         the attributes as needed
    

























    ---------------------------------------------- AI ----------------------------------------------------------


    
Full Drives Backend Resource & Route List

Each row shows: API route → HTTP method → Lambda function → primary AWS resources used

A. API Gateway routes 
Route	Method	Lambda (function)	Purpose 
/drive/presigned	POST	getPresignedUrl	Generate presigned URL for upload (to drive-unscanned) or download (from drive). Request body includes `{ action: 'upload'
/drive/share	POST	presignedUrlShare	Create shareable presigned GET URL (user chooses expiry up to 7 days). Logs share record.
/drive	GET	listFiles	List user files (with query params: folderId, tag, private, page, limit). Reads drive-table.
/drive/recent	GET	getRecentFiles	Return user-specific recently accessed files (ordered by lastAccessed).
/drive	POST	createFileRecord	(Optional) Record file metadata after upload (if you separate upload & metadata).
/drive/:id	GET	getFileInfo	Return metadata for a single file.
/drive/:id	PATCH	updateFileMetadata	Partial update (rename, update tags, set private flag).
/drive/:id/move	PATCH	moveFile	Move file to another folder (update S3 key and drive-table).
/drive/:id/copy	POST	copyFile	Copy a file to another folder/user.
/drive/:id	DELETE	softDeleteFile	Soft-delete (mark trashed in drive-table and move to drive-quarantined or trash prefix).
/drive/:id/restore	POST	restoreFile	Restore from trash (clear trashed flag, move object back).
/drive/:id/download	GET	downloadProxy (optional)	Optionally proxy download through backend or return presigned URL (recommended: return presigned).
/drive/:id/preview	GET	getFilePreview	Return preview/thumbnail or presigned URL to preview.
/drive/tag/:tag	GET	getFilesByTag	List files by tag for the user.
/drive/folder/:folderId	GET	getFilesByFolder	List files in a folder.
/drive/trash	GET	listTrash	List soft-deleted files for user (drive-table filtered by trashed).
/drive/scan/status/:fileId	GET	getScanStatus	Check scan status from scan-table.
/admin/quarantine	GET/POST/DELETE	adminQuarantineActions	Admin-only endpoints for manual review and deletion (secure).

Note: many of these can be combined or split; I listed them explicitly for clarity.

B. Lambda functions (detailed)

getPresignedUrl

Generates S3 presigned POST for uploads to drive-unscanned/{userId}/... and presigned GET for drive/{userId}/... downloads.

Validates JWT ownership and upload rules (size, file type if needed).

presignedUrlShare

Validates ownership, creates presigned GET URL up to 7 days, writes a share log to DynamoDB or audit table.

uploadCallback or createFileRecord (optional)

If you want the frontend to notify after successful upload (or scanner writes metadata), this records metadata to scan-table with status pending.

scanProcessor (or orchestrator)

Orchestrates virus-scan: triggered by S3 event or SQS queue. Sends file to Marketplace scanner, updates scan-table status (in_progress → clean/infected), and moves objects between buckets (copy/delete). May use Step Functions if multi-step.

moveFile

Copies object in S3 (appropriate bucket/prefix), updates drive-table metadata (s3Key, folderId), deletes old key.

copyFile

Similar to move but keeps original and writes new record.

getFileInfo

Reads drive-table item for file metadata.

updateFileMetadata

Applies PATCH updates (rename, tags, privacy flags) to drive-table (and optionally rename S3 object if name affects key).

deleteFile (softDeleteFile)

Marks trashed=true, sets trashExpiry = now + 7 days; optionally copies object to drive-quarantined or drive/trash/ prefix and removes public access.

restoreFile

Moves object back from trash/quarantine, clears trashed flag.

downloadProxy (optional)

Optionally create signed URL for download; usually getPresignedUrl covers this.

getRecentFiles / listFiles

Query drive-table (GSI by userId + lastAccessed or createdAt).

cleanupWorker (scheduled)

EventBridge scheduled Lambda that permanently deletes objects whose trashExpiry has passed (and cleans DynamoDB entries).

adminQuarantineActions

Admin-only actions (investigate, delete permanently).

C. Storage & DB (already mostly covered)

S3 buckets

drive-unscanned (uploads only)

drive (clean files)

drive-quarantined (infected/quarantine)

drive-trash prefix in drive 

DynamoDB tables

scan-table (PK: user_id, SK: file_id) — scanning lifecycle + status + checksum + quarantineLocation + scannedAt etc.

drive-table (PK: user_id, SK: file_id) — canonical drive metadata, lastAccessed, trashed, tags, folderId.

share-table — store active share links / audit logs.

Indexes

GSI on drive-table for querying by user_id + lastAccessed (for recent).

GSI on drive-table for user_id + folderId (for folder listing).

GSI on scan-table for status queries if needed.

D. Queues & Workflow

SQS queue (recommended)

S3 Event Notification → SQS (for drive-unscanned uploads). Ensures reliable scanning, controls concurrency (e.g., consumer processes 25 at a time).

AWS Step Functions (optional (if you see the need))

For orchestrating complex flows: request presigned URL → upload → scan request → polling scan result → move file → update DB.

EventBridge / CloudWatch Events

Schedule cleanupWorker for permanent deletion (daily) and metrics/alarms.

E. Auth / Monitoring / Roles

Amazon Cognito (or your chosen auth)

Authenticate users; userId from token used to restrict access.

IAM Roles & Policies (examples)

AppUploadRole — allowed to s3:PutObject only on drive-unscanned/* for presigned generation if you use temporary creds.

ScannerRole — s3:GetObject on drive-unscanned/*, s3:PutObject on drive/* and drive-quarantined/*.

LambdaRole — for each Lambda, fine-grained permissions to S3, DynamoDB, SQS.

PresignedGeneratorPolicy — allows s3:PutObject (for upload presigned), s3:GetObject for download presigned limited to drive/*.

Admin roles for quarantine access.

CloudWatch Logs & Metrics

Log Lambdas and scanner statuses; set alarms for failures or queue depth.

F. Additional supporting resources

SNS — user notifications (optional) for infected file alerts.

Secrets Manager / Parameter Store — store scanner config, API keys, signing salts.

VPC (if scanner requires private access) — if your Marketplace scanner runs in a VPC or EC2.

G. Security & Policies — High level checklist

Presigned URLs are scoped to specific key prefixes (userId); validate server-side before issuing.

DO NOT allow list/get access to drive-unscanned from users — uploads only.

Use encryption at rest (SSE-S3 / SSE-KMS) on all buckets.

Enable S3 server access / CloudTrail logging for auditing.

Use least-privilege IAM for scanner service.

H. Mapping summary (compact)

POST /drive/presigned → getPresignedUrl → S3 drive-unscanned or drive (GET)

POST /drive/share → presignedUrlShare → S3 drive

POST /drive → createFileRecord → writes scan-table pending

S3 drive-unscanned upload event → S3 Event → SQS → scanProcessor (Marketplace scanner) → updates scan-table and moves objects to drive or drive-quarantined → update drive-table

GET /drive → listFiles → query drive-table

PATCH /drive/:id → updateFileMetadata → update drive-table

PATCH /drive/:id/move → moveFile → copy/delete S3 + update drive-table

DELETE /drive/:id → softDeleteFile → update drive-table, move S3 to drive-quarantined or drive/trash prefix

POST /drive/:id/restore → restoreFile → reverse of soft delete